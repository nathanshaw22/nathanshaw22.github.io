<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sober or Not?</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: white;
      text-align: center;
      padding: 30px;
    }
    input, button {
      padding: 10px;
      margin: 10px;
      font-size: 16px;
    }
    .link-box {
      margin: 10px auto;
      padding: 10px;
      background: #222;
      border-radius: 8px;
      width: 80%;
      word-wrap: break-word;
    }
    .reveal {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #111;
      color: white;
    }
    #revealBtn {
      font-size: 24px;
      padding: 20px 40px;
      border: none;
      border-radius: 12px;
      background: #444;
      cursor: pointer;
      transition: background 0.3s;
    }
    #revealBtn:hover {
      background: #666;
    }
    #role {
      font-size: 48px;
      display: none;
      animation: fadeIn 2s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.8); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>

  <h1>üçª Sober or Not? üé≤</h1>
  <div id="setup">
    <label for="numPlayers">Number of players:</label>
    <input type="number" id="numPlayers" min="2" max="20" value="4"><br>
    <label for="numNotSober">Number of Not Sobers:</label>
    <input type="number" id="numNotSober" min="1" max="20">
    <small>(leave blank for random)</small><br>
    <button onclick="generateLinks()">Generate Game Links</button>
  </div>

  <div id="links"></div>

  <script>
    // --- Fixed-length, URL-safe Base64 helpers ---
    function toBase64Url(bytes) {
      let binary = "";
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/,"");
    }
    function fromBase64Url(str) {
      let base64 = str.replace(/-/g, "+").replace(/_/g, "/");
      const pad = base64.length % 4;
      if (pad) base64 += "=".repeat(4 - pad);
      const binary = atob(base64);
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      return bytes;
    }

    // Encode role into a CONSTANT-LENGTH token:
    // Use 18 bytes (multiple of 3) -> always 24 base64url chars, no padding.
    function encodeRole(role) {
      const bytes = new Uint8Array(18);
      // 0 = Sober, 1 = Not Sober
      bytes[0] = role === "Not Sober" ? 1 : 0;
      crypto.getRandomValues(bytes.subarray(1)); // fill remaining 17 bytes
      return toBase64Url(bytes); // always 24 characters
    }
    function decodeRole(token) {
      try {
        const bytes = fromBase64Url(token);
        if (bytes.length < 1) return null;
        return bytes[0] === 1 ? "Not Sober" : "Sober";
      } catch {
        return null;
      }
    }

    function generateLinks() {
      const numPlayers = parseInt(document.getElementById("numPlayers").value);
      let numNotSober = document.getElementById("numNotSober").value;

      if (!numNotSober) {
        numNotSober = Math.floor(Math.random() * numPlayers) + 1;
      } else {
        numNotSober = Math.min(parseInt(numNotSober), numPlayers);
      }

      // Assign roles
      let roles = Array(numPlayers).fill("Sober");
      for (let i = 0; i < numNotSober; i++) {
        let idx;
        do {
          idx = Math.floor(Math.random() * numPlayers);
        } while (roles[idx] === "Not Sober");
        roles[idx] = "Not Sober";
      }

      // Generate encoded links (tokens now SAME LENGTH for all roles)
      const baseUrl = window.location.href.split("?")[0];
      const linksDiv = document.getElementById("links");
      linksDiv.innerHTML = "<h2>Send these links to each player:</h2>";

      roles.forEach((role, i) => {
        const token = encodeRole(role);
        const url = `${baseUrl}?t=${token}`;
        linksDiv.innerHTML += `
          <div class="link-box">
            Player ${i+1}: <a href="${url}" target="_blank">${url}</a>
          </div>
        `;
      });
    }

    // If player opened a link
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get("t");
    if (token) {
      const role = decodeRole(token);
      document.body.innerHTML = `
        <div class="reveal">
          <button id="revealBtn">Click to Reveal Your Role</button>
          <div id="role"></div>
        </div>
      `;
      document.getElementById("revealBtn").addEventListener("click", () => {
        const roleDiv = document.getElementById("role");
        roleDiv.textContent = role || "Unknown";
        roleDiv.style.display = "block";
        document.getElementById("revealBtn").style.display = "none";
        document.body.style.background = role === "Not Sober" ? "#900" : "#090";
      });
    }
  </script>
</body>
</html>
