<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sober or Not?</title>
  <style>
    body { font-family: Arial, sans-serif; background: #111; color: white; text-align: center; padding: 30px; }
    input, button { padding: 10px; margin: 10px; font-size: 16px; }
    .link-box { margin: 10px auto; padding: 10px; background: #222; border-radius: 8px; width: 80%; word-wrap: break-word; }
    .reveal { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: #111; color: white; }
    #revealBtn { font-size: 24px; padding: 20px 40px; border: none; border-radius: 12px; background: #444; cursor: pointer; transition: background 0.3s; }
    #revealBtn:hover { background: #666; }
    #role { font-size: 48px; display: none; animation: fadeIn 2s; margin-top: 20px; }
    #countdown { font-size: 60px; margin-top: 20px; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
  </style>
</head>
<body>

<h1>üçª Sober or Not? üé≤</h1>
<div id="setup">
  <label for="numPlayers">Number of players:</label>
  <input type="number" id="numPlayers" min="2" max="20" value="4"><br>
  
  <label for="minNotSober">Minimum Not Sobers:</label>
  <input type="number" id="minNotSober" min="0" max="20"><br>
  
  <label for="numNotSober">Maximum/Exact Not Sobers (leave blank for random ‚â• minimum):</label>
  <input type="number" id="numNotSober" min="0" max="20"><br>
  
  <button onclick="generateLinks()">Generate Game Links</button>
</div>

<div id="links"></div>

<script>
  // --- Fixed-length, URL-safe Base64 helpers ---
  function toBase64Url(bytes) {
    let binary = "";
    for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
    return btoa(binary).replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/,"");
  }
  function fromBase64Url(str) {
    let base64 = str.replace(/-/g, "+").replace(/_/g, "/");
    const pad = base64.length % 4;
    if (pad) base64 += "=".repeat(4 - pad);
    const binary = atob(base64);
    const bytes = new Uint8Array(binary.length);
    for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
    return bytes;
  }
  function encodeRole(role) {
    const bytes = new Uint8Array(18);
    bytes[0] = role === "Not Sober" ? 1 : 0;
    crypto.getRandomValues(bytes.subarray(1));
    return toBase64Url(bytes);
  }
  function decodeRole(token) {
    try {
      const bytes = fromBase64Url(token);
      if (bytes.length < 1) return null;
      return bytes[0] === 1 ? "Not Sober" : "Sober";
    } catch { return null; }
  }

  function generateLinks() {
    const numPlayers = parseInt(document.getElementById("numPlayers").value);
    let minNotSober = parseInt(document.getElementById("minNotSober").value) || 0;
    let numNotSoberInput = document.getElementById("numNotSober").value;
    let numNotSober;

    if (!numNotSoberInput) {
      numNotSober = Math.floor(Math.random() * (numPlayers - minNotSober + 1)) + minNotSober;
    } else {
      numNotSober = Math.min(parseInt(numNotSoberInput), numPlayers);
      if (numNotSober < minNotSober) numNotSober = minNotSober;
    }

    let roles = Array(numPlayers).fill("Sober");
    for (let i = 0; i < numNotSober; i++) {
      let idx;
      do { idx = Math.floor(Math.random() * numPlayers); } 
      while (roles[idx] === "Not Sober");
      roles[idx] = "Not Sober";
    }

    const baseUrl = window.location.href.split("?")[0];
    const linksDiv = document.getElementById("links");
    linksDiv.innerHTML = "<h2>Send these links to each player:</h2>";
    roles.forEach((role, i) => {
      const token = encodeRole(role);
      const url = `${baseUrl}?t=${token}`;
      linksDiv.innerHTML += `<div class="link-box">Player ${i+1}: <a href="${url}" target="_blank">${url}</a></div>`;
    });
  }

  const countdownAudio = new Audio("/mnt/data/tense_full_orchestra_chord_swell.mp3");
  const revealAudio = new Audio("/mnt/data/funny-dramatic-gasp-320975.mp3");

  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get("t");
  if (token) {
    const role = decodeRole(token);
    document.body.innerHTML = `
      <div class="reveal">
        <button id="revealBtn">Click to Reveal Your Role</button>
        <div id="countdown"></div>
        <div id="role"></div>
      </div>
    `;
    const revealBtn = document.getElementById("revealBtn");
    const countdownDiv = document.getElementById("countdown");
    const roleDiv = document.getElementById("role");

    revealBtn.addEventListener("click", () => {
      revealBtn.style.display = "none";
      countdownAudio.play();
      let count = 3;
      countdownDiv.textContent = count;
      const interval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownDiv.textContent = count;
        } else {
          clearInterval(interval);
          countdownDiv.textContent = "Your Role is...";
          revealAudio.play();
          setTimeout(() => {
            countdownDiv.style.display = "none";
            roleDiv.textContent = role || "Unknown";
            roleDiv.style.display = "block";
            document.body.style.background = role === "Not Sober" ? "#900" : "#090";
          }, 1000);
        }
      }, 1000);
    });
  }
</script>
</body>
</html>
