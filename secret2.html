from flask import Flask, request, redirect, url_for, render_template_string
import secrets

app = Flask(__name__)

# Store game data in memory
games = {}

# HTML templates
index_html = """
<!DOCTYPE html>
<html>
<head>
    <title>Role Generator</title>
</head>
<body>
    <h1>Create a Game</h1>
    <form method="POST" action="/create">
        Number of Players: <input type="number" name="num_players" min="2" required><br>
        Number of Nonsober: <input type="number" name="num_nonsober" min="1" required><br>
        <button type="submit">Create Game</button>
    </form>
</body>
</html>
"""

links_html = """
<!DOCTYPE html>
<html>
<head>
    <title>Game Links</title>
</head>
<body>
    <h1>Share These Links</h1>
    <ul>
        {% for link in links %}
            <li><a href="{{ link }}" target="_blank">{{ link }}</a></li>
        {% endfor %}
    </ul>
</body>
</html>
"""

role_html = """
<!DOCTYPE html>
<html>
<head>
    <title>Your Role</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin-top: 100px; }
        #role { font-size: 2em; display: none; }
        button { font-size: 1.5em; padding: 10px 20px; }
    </style>
    <script>
        function reveal() {
            document.getElementById('role').style.display = 'block';
            document.getElementById('reveal').style.display = 'none';
        }
    </script>
</head>
<body>
    <h1>Your Secret Role</h1>
    <button id="reveal" onclick="reveal()">Reveal Role</button>
    <p id="role">{{ role }}</p>
</body>
</html>
"""

@app.route("/")
def index():
    return render_template_string(index_html)

@app.route("/create", methods=["POST"])
def create():
    num_players = int(request.form["num_players"])
    num_nonsober = int(request.form["num_nonsober"])
    game_id = secrets.token_hex(4)

    # Assign roles
    roles = ["Nonsober"] * num_nonsober + ["Sober"] * (num_players - num_nonsober)
    secrets.SystemRandom().shuffle(roles)

    # Generate unique tokens (same length regardless of role)
    players = {}
    max_len = 32  # fixed length for all tokens
    for role in roles:
        raw_token = secrets.token_hex(16)  # generate random hex
        padded_token = raw_token.ljust(max_len, "x")  # pad with filler to fixed length
        players[padded_token] = role

    games[game_id] = players

    # Generate player links
    links = [url_for("reveal", game_id=game_id, token=token, _external=True) for token in players.keys()]
    return render_template_string(links_html, links=links)

@app.route("/reveal/<game_id>/<token>")
def reveal(game_id, token):
    if game_id not in games or token not in games[game_id]:
        return "Invalid link!"
    role = games[game_id][token]
    return render_template_string(role_html, role=role)

if __name__ == "__main__":
    app.run(debug=True)
