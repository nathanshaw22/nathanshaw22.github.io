<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sober Game Role Reveal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin-top: 50px;
    }
    #reveal {
      font-size: 2em;
      margin-top: 20px;
      display: none;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2em;
    }
  </style>
</head>
<body>
  <h1>Sober Game Role Reveal</h1>
  <button id="revealBtn">Reveal My Role</button>
  <div id="reveal"></div>

  <script>
    // Create a fixed-length token
    function generateToken(role, length = 12) {
      const base = btoa(role); // encode the role
      let padded = base;
      while (padded.length < length) {
        padded += Math.random().toString(36).substring(2, 3);
      }
      return padded.substring(0, length);
    }

    // Decode token safely
    function decodeToken(token) {
      try {
        // Strip padding randomness by trying to decode progressively
        for (let i = token.length; i > 0; i--) {
          try {
            return atob(token.substring(0, i));
          } catch {}
        }
      } catch {
        return null;
      }
      return null;
    }

    // ---- HOST SIDE GENERATION ----
    // Call this in the console or adapt into a host page
    function generateAssignments(numPlayers, numNonsober) {
      const roles = Array(numNonsober).fill("Non-Sober")
        .concat(Array(numPlayers - numNonsober).fill("Sober"));

      // shuffle roles
      for (let i = roles.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [roles[i], roles[j]] = [roles[j], roles[i]];
      }

      // create links
      const links = roles.map((role, idx) => {
        const token = generateToken(role);
        return `${window.location.origin}${window.location.pathname}?id=${token}`;
      });

      console.log("Player Links:", links);
      return links;
    }

    // ---- PLAYER SIDE ----
    const params = new URLSearchParams(window.location.search);
    const token = params.get("id");

    document.getElementById("revealBtn").addEventListener("click", () => {
      const role = decodeToken(token);
      const revealDiv = document.getElementById("reveal");

      if (role) {
        revealDiv.textContent = `You are: ${role}`;
      } else {
        revealDiv.textContent = "Invalid or missing link!";
      }
      revealDiv.style.display = "block";
    });
  </script>
</body>
</html>
